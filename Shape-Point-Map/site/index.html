<html>
<head>
    <title>Shape Point Map</title>

    <!-- Include css files and a favicon icon -->
    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="css/style.css"/>
    <link rel="stylesheet" href="css/leaflet.zoomhome.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/L.Control.MousePosition.css"/>
    
    <!-- Include javascript files -->
    <script src="javascript/leaflet.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="javascript/leaflet.zoomhome.min.js"></script>
    <script src="javascript/L.Control.MousePosition.js"></script>
    <script src="javascript/leaflet-color-markers.js"></script>
    <script src="javascript/leaflet-svg-shape-markers.min.js"></script>

</head>

<header>
    <h1>Leaflet Shape Point Map Example</h1>
</header>

<body>
    <div id="mapid">
        <script>
            /* Variable called map. This is what creates the actual leaflet map */
            var map = L.map('mapid', {zoomControl: false}).setView([38.99, -105.54], 7);

            /* Tile Layer that is added to our map. In this case it is a mapbox streets tile layer. */
            L.tileLayer('https://api.mapbox.com/styles/v1/korysam/cixur5uy7003g2sqwthpjmbxa/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoia29yeXNhbSIsImEiOiJjaXd4dDRxbTQwMXRkMm9tZzd5b3BqdTBwIn0.A2EGyNrWG2Lbbd5c-I-94w', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy;<a href="http://mapbox.com">Mapbox</a>',
                    maxZoom: 18
                }).addTo(map);

            /* Top Left Corner of Map. Allows for a home button to reset to the default zoom. */
            var zoomHome = L.Control.zoomHome();
            zoomHome.addTo(map);
           
            /* Bottom Right corner. This shows the current lat and long  of the mouse cursor. 
            'ยบ' used for the degree character when the latitude and longitude of the 
            cursor is dispalyed. */
            L.control.mousePosition({position: 'bottomleft',lngFormatter: function(num) {
                var direction = (num < 0) ? 'W' : 'E';
                var formatted = Math.abs(L.Util.formatNum(num, 3)) + 'ยบ ' + direction;
                return formatted; 
            },
            latFormatter: function(num) {
                var direction = (num < 0) ? 'S' : 'N';
                var formatted = Math.abs(L.Util.formatNum(num, 3)) + 'ยบ ' + direction;
                return formatted;
            }}).addTo(map);


            /* Bottom Left corner. This shows the scale in km and miles of
            the map. */
            L.control.scale({position: 'bottomleft',imperial: true}).addTo(map);

            /* Checks is color option is empty or not a valid color */
            function isValidColor(strColor) {
                if(strColor == ""){
                    return false;
                }
                var s = new Option().style;
                s.color = strColor;
                var test1 = s.color == strColor.toLowerCase();
                var test2 = /^#[0-9A-F]{6}$/i.test(strColor);
                if(test1 == true || test2 == true){
                    return true;
                } else{
                    return false;
                }
            }

            /* Checks is number option is empty or not a valid number */
            function isValidNumber(strNum){
                if(strNum == ""){
                    return false;
                }
                return !isNaN(strNum);
            }

            /* Checks is shape option is empty or not a valid shape */
            function isValidShape(strShape){
                if(strShape == 'diamond' || strShape == 'square' || strShape == 'triangle' || strShape == 'triangle-up' || strShape == 'triangle-down' || strShape == 'circle' || strShape == 'x'){
                    return true;
                }
                return false;
            }  

            /* These arrays are used to hold values which will later be used in the key of the map */
            var names = [];
            var colors = [];

            /* Reads in .json file which describes the format of the map */
            $.ajax({
                url: "maps/point_layers_2019-05-15.json",
                async: false,
                dataType: 'json',
                error: function(error){
                    throw new Error(error);
                },
                success: function(json){
                    /* Loops through the layers decribed in the .json file */
                    for(var i = 1; i < (json.layers).length; i++){
                        /* Set the default values */
                        let this_weight = 2;            // outline width in pixels
                        let this_opacity = 1;           // opacity of outline
                        let this_color = 'black';       // color of outline
                        let this_fillOpacity = 0.3;     // opacity of shape interior
                        let this_fillColor = 'red';     // color of shape interior
                        let this_shape = 'diamond';     // style of shape (only avaliable with leaflet-svg-shape-markers.min.js)
                        let this_radius = 5;            // size of shape
                                                /* For more options see path options in https://leafletjs.com/reference-1.5.0.html#path-color */

                        /* If a value is specified in the .json file, override the default value */
                        if(isValidNumber(json.layerViewGroups[0].layerViews[i].symbol.lineWidth))
                            this_weight = json.layerViewGroups[0].layerViews[i].symbol.lineWidth;
                        if(isValidColor(json.layerViewGroups[0].layerViews[i].symbol.color))
                            this_fillColor = json.layerViewGroups[0].layerViews[i].symbol.color;
                        if(isValidColor(json.layerViewGroups[0].layerViews[i].symbol.outlineColor))
                            this_color = json.layerViewGroups[0].layerViews[i].symbol.outlineColor;
                        if(isValidNumber(json.layerViewGroups[0].layerViews[i].symbol.size))
                            this_radius = json.layerViewGroups[0].layerViews[i].symbol.size;
                        if(isValidShape(json.layerViewGroups[0].layerViews[i].symbol.marker))
                            this_shape = json.layerViewGroups[0].layerViews[i].symbol.marker;
                        if(isValidNumber(json.layerViewGroups[0].layerViews[i].symbol.opacity))
                            this_opacity = json.layerViewGroups[0].layerViews[i].symbol.opacity;
                        if(isValidNumber(json.layerViewGroups[0].layerViews[i].symbol.fillOpacity))
                            this_fillOpacity = json.layerViewGroups[0].layerViews[i].symbol.fillOpacity;

                        names.push(json.layerViewGroups[0].layerViews[i].layerId);
                        colors.push(json.layerViewGroups[0].layerViews[i].symbol.color);

                        /* Get the geoJSON data corresponding to the .json layer the loop is currently on
                        and for each data point create a marker using the attributes above */
                        $.getJSON(json.layers[i].source,function(data){
                            let geolayer = L.geoJSON(data, {
                            pointToLayer: function(feature, latlng) {
                                let geomarker = L.shapeMarker(latlng, {
                                    weight: this_weight,
                                    opacity: this_opacity,
                                    color: this_color,
                                    fillOpacity: this_fillOpacity,
                                    fillColor: this_fillColor,
                                    shape: this_shape,
                                    radius: this_radius
                                }).addTo(map);
                            }
                            })
                        });
                    }
                }
            });
            /* Bottom Right Corner. This shows the legend for the map */
            var legend = L.control({position: 'bottomright'});

            legend.onAdd = function (map) {

                var div = L.DomUtil.create('div', 'info legend');
                div.innerHTML += '<h4>Key</h4>';
                for(var j = 0; j < names.length; j++){
                    div.innerHTML += '<i style="background:' + colors[j] + '"></i> ' + names[j] + "<br><br>";
                }
                return div;
            };

            legend.addTo(map);
        </script>
    </div>
</body>
</html>